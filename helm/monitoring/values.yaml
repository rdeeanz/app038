# Global settings
global:
  namespace: monitoring
  storageClass: standard

# Prometheus configuration
prometheus:
  enabled: true
  prometheusSpec:
    retention: 30d
    retentionSize: 50GB
    scrapeInterval: 30s
    evaluationInterval: 30s
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: standard
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    alerting:
      alertmanagers:
        - namespace: monitoring
          name: alertmanager-main
          port: web
    additionalScrapeConfigs:
      - job_name: 'laravel-app'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - default
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: laravel
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: $1:9090
      - job_name: 'svelte-frontend'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - default
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: svelte
          - source_labels: [__meta_kubernetes_pod_ip]
            action: replace
            target_label: __address__
            replacement: $1:9090

  alertmanager:
    enabled: true
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ['alertname', 'cluster', 'service']
          group_wait: 10s
          group_interval: 10s
          repeat_interval: 12h
          receiver: 'default'
          routes:
            - match:
                severity: critical
              receiver: 'critical-alerts'
              continue: true
            - match:
                severity: warning
              receiver: 'warning-alerts'
        receivers:
          - name: 'default'
            webhook_configs:
              - url: 'http://webhook-receiver:8080/alerts'
          - name: 'critical-alerts'
            webhook_configs:
              - url: 'http://webhook-receiver:8080/alerts/critical'
          - name: 'warning-alerts'
            webhook_configs:
              - url: 'http://webhook-receiver:8080/alerts/warning'

  serverFiles:
    alerts: {}
    rules:
      groups:
        - name: slo.rules
          interval: 30s
          rules:
            - record: job:http_request_duration_seconds:rate5m
              expr: sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le)
            - record: job:http_request_duration_seconds:quantile
              expr: histogram_quantile(0.99, job:http_request_duration_seconds:rate5m)

# Grafana configuration
grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin
  persistence:
    enabled: true
    storageClassName: standard
    size: 10Gi
  service:
    type: ClusterIP
    port: 80
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - grafana.app038.local
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus-server:80
          isDefault: true
          jsonData:
            timeInterval: 30s
        - name: Loki
          type: loki
          access: proxy
          url: http://loki:3100
          jsonData:
            maxLines: 1000
        - name: Jaeger
          type: jaeger
          access: proxy
          url: http://jaeger-query:16686
          jsonData:
            tracesToLogs:
              datasourceUid: loki
  dashboards:
    default:
      app038-overview:
        gnetId: 0
        revision: 0
        datasource: Prometheus
      app038-slo:
        gnetId: 0
        revision: 0
        datasource: Prometheus

# Loki configuration
loki:
  enabled: true
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
      filesystem:
        chunks_directory: /loki/chunks
        rules_directory: /loki/rules
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    limits:
      retention_period: 168h
      ingestion_rate_mb: 16
      ingestion_burst_size_mb: 32
      max_query_length: 721h
      max_query_parallelism: 32
      max_streams_per_user: 10000
      max_line_size: 256KB
  persistence:
    enabled: true
    storageClassName: standard
    size: 50Gi
  gateway:
    enabled: true
  promtail:
    enabled: true
    config:
      clients:
        - url: http://loki-gateway/loki/api/v1/push
      scrapeConfigs:
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_controller_name
              regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
              action: replace
              target_label: __tmp_controller_name
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_name
                - __meta_kubernetes_pod_label_app
                - __tmp_controller_name
                - __meta_kubernetes_pod_name
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_instance
                - __meta_kubernetes_pod_label_release
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: instance
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_component
                - __meta_kubernetes_pod_label_component
              regex: ^;*([^;]+)(;.*)?$
              action: replace
              target_label: component
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - action: replace
              replacement: $1
              separator: /
              source_labels:
                - __meta_kubernetes_namespace
                - app
              target_label: job
            - action: replace
              source_labels:
                - __meta_kubernetes_namespace
              target_label: namespace
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_name
              target_label: pod
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_container_name
              target_label: container
            - action: replace
              replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
            - action: replace
              regex: true
              replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__

# Jaeger configuration
jaeger:
  enabled: true
  nameOverride: jaeger
  fullnameOverride: jaeger
  agent:
    enabled: true
    strategy: DaemonSet
  collector:
    enabled: true
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
  query:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - jaeger.app038.local
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
  storage:
    type: elasticsearch
    elasticsearch:
      host: elasticsearch.logging.svc.cluster.local
      port: 9200
      scheme: http
  serviceAccount:
    create: true

