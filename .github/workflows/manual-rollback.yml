name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Helm revision to rollback to (leave empty for previous)'
        required: false
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        default: 'app038-production'
        type: string

env:
  KUBERNETES_NAMESPACE: ${{ github.event.inputs.namespace }}

jobs:
  rollback:
    name: Manual Rollback
    runs-on: ubuntu-latest
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'
      
      - name: Configure kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Set up Kubernetes context
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
      
      - name: Get Helm history
        id: history
        run: |
          helm history app038 --namespace ${{ env.KUBERNETES_NAMESPACE }} --output json > history.json
          cat history.json
        continue-on-error: true
      
      - name: Determine rollback revision
        id: determine-revision
        run: |
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            REVISION="${{ github.event.inputs.revision }}"
          else
            REVISION=$(jq -r '.[1].revision // "0"' history.json 2>/dev/null || echo "0")
          fi
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "Rolling back to revision: $REVISION"
      
      - name: Rollback Helm release
        run: |
          if [ "${{ steps.determine-revision.outputs.revision }}" != "0" ]; then
            helm rollback app038 ${{ steps.determine-revision.outputs.revision }} \
              --namespace ${{ env.KUBERNETES_NAMESPACE }} \
              --wait \
              --timeout 10m
            echo "✅ Successfully rolled back to revision ${{ steps.determine-revision.outputs.revision }}"
          else
            echo "❌ No valid revision found for rollback"
            exit 1
          fi
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
      - name: Verify rollback
        run: |
          kubectl rollout status deployment/app038-laravel --namespace=${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/app038-svelte --namespace=${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
          echo "✅ Rollback verification complete"

